<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>黃金切割率</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="container">
    <h1 class="page-title">黃金切割率</h1>

    <section class="card">
      <div class="row">
        <label for="lowest">最低</label>
        <input id="lowest" type="number" step="0.01" placeholder="輸入最低價值" />
      </div>
      <div class="row">
        <label for="highest">最高</label>
        <input id="highest" type="number" step="0.01" placeholder="輸入最高價值" />
      </div>
      <div class="row">
        <label for="k">k</label>
        <input id="k" type="number" step="0.001" value="0.618" min="0" max="1" />
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th id="target-title">反彈目標</th>
              <th>0.382</th>
              <th>0.5</th>
              <th>0.618</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span id="targetresult" class="mono">--</span></td>
              <td><span id="v-0.382" class="mono">--</span></td>
              <td><span id="v-0.5" class="mono">--</span></td>
              <td><span id="v-0.618" class="mono">--</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="actions">
        <button id="btn-copy" type="button">複製</button>
        <span id="copied-msg" class="muted" aria-live="polite"></span>
      </div>
    </section>
  </main>

  <script>
    // 四捨五入到小數第 2 位
    function round2(n) {
      if (!isFinite(n)) return '--';
      return (Math.round(n * 100) / 100).toFixed(2);
    }

    // 計算與更新畫面
    function recalc() {
      const lowestEl = document.getElementById('lowest');
      const highestEl = document.getElementById('highest');
      const kEl = document.getElementById('k');

      const lowest = parseFloat(lowestEl.value);
      const highest = parseFloat(highestEl.value);
      const k = parseFloat(kEl.value);

      const titleEl = document.getElementById('target-title');
      const targetEl = document.getElementById('targetresult');
      const v382El = document.getElementById('v-0.382');
      const v50El = document.getElementById('v-0.5');
      const v618El = document.getElementById('v-0.618');

      // 標題判斷：if [最低價值] <= [最高價的值] then "反彈目標" else "修正目標"
      if (isFinite(lowest) && isFinite(highest)) {
        titleEl.textContent = (lowest <= highest) ? '反彈目標' : '修正目標';
      } else {
        titleEl.textContent = '反彈目標';
      }

      // 主要目標值：value = (Lowest)^(1−k) × (Highest)^k
      let targetVal = NaN;
      if (isFinite(lowest) && isFinite(highest) && isFinite(k)) {
        targetVal = Math.pow(lowest, (1 - k)) * Math.pow(highest, k);
      }
      targetEl.textContent = round2(targetVal);

      // 斐波那契等比（線性內插常見作法）：lowest + ratio * (highest - lowest)
      let v382 = NaN, v50 = NaN, v618 = NaN;
      if (isFinite(lowest) && isFinite(highest)) {
        const diff = (highest - lowest);
        v382 = lowest + 0.382 * diff;
        v50 = lowest + 0.5 * diff;
        v618 = lowest + 0.618 * diff;
      }
      v382El.textContent = round2(v382);
      v50El.textContent = round2(v50);
      v618El.textContent = round2(v618);
    }

    // 複製指定格式
    async function copyBundle() {
      const t = document.getElementById('targetresult').textContent.trim();
      const v382 = document.getElementById('v-0.382').textContent.trim();
      const v50 = document.getElementById('v-0.5').textContent.trim();
      const v618 = document.getElementById('v-0.618').textContent.trim();

      // 按需求的字串：
      // [targetresult] + \n + "0.382" + [v-0.382] + \n + "0.5=" + [v-0.5] + \n + "0.618" + [v-0.618]
      const payload = `${t}\n0.382=${v382}\n0.5=${v50}\n0.618${v618}`;

      try {
        await navigator.clipboard.writeText(payload);
        showCopied('已複製到剪貼簿！');
      } catch (err) {
        // 後備方案（選取+execCommand）
        const ta = document.createElement('textarea');
        ta.value = payload;
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          showCopied('已複製到剪貼簿！');
        } catch (e) {
          showCopied('複製失敗，請手動選取。');
        } finally {
          document.body.removeChild(ta);
        }
      }
    }

    function showCopied(msg) {
      const el = document.getElementById('copied-msg');
      el.textContent = msg;
      setTimeout(() => el.textContent = '', 2000);
    }

    // 綁定事件
    document.getElementById('lowest').addEventListener('input', recalc);
    document.getElementById('highest').addEventListener('input', recalc);
    document.getElementById('k').addEventListener('input', recalc);
    document.getElementById('btn-copy').addEventListener('click', copyBundle);

    // 初始計算
    recalc();
  </script>
</body>
</html>
